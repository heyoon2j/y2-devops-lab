name: Terraform Plan on Preview PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [preview]

permissions:
  contents: write
  pull-requests: write

env:
  TF_VERSION: 1.6.6
  GIT_USER_NAME: github-actions[bot]
  GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com
  PR_BRANCH: preview


jobs:
  plan:
    name: Terraform Plan & Summary (on PR creation) 
    #if: github.event.issue.pull_request && contains(github.event.comment.body, 'terraform plan')
    runs-on: local # [self-hosted, macOS]

    steps:
      - name: Checkout
        uses: actions/checkout@v4               # runnerì—ì„œ í•´ë‹¹ PRì˜ ì½”ë“œë¥¼ checkout(ë‹¤ìš´ë¡œë“œ)í•˜ëŠ” ê³µì‹ ì•¡ì…˜
        with:
          fetch-depth: 0
      
      # ì„œë²„ ìžì²´ì— ë“±ë¡í•˜ê¸°
      - name: Configure Git
        run: |
          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"

      - name: Merge preview branch (check conflict)
        run: |
          git fetch origin ${PR_BRANCH}
          git merge --no-edit origin/${PR_BRANCH} || {
            echo "::error ::âŒ Merge conflict with ${PR_BRANCH} branch. Please rebase your branch."
            exit 1
          }

#      - name: Install GitHub CLI
#        run: brew install gh

      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v3
      #   with:
      #     terraform_version: ${{ env.TF_VERSION }}

      - name: Set Terraform Workdir
        id: tfworkdir
        run: |
          BRANCH_NAME=${GITHUB_HEAD_REF:-$(git rev-parse --abbrev-ref HEAD)}
          WORKDIR=$(cat .github/terraform/.terraform_workdir.${BRANCH_NAME})
          echo "workdir=$WORKDIR" >> $GITHUB_OUTPUT

      - name: Terraform Init (dynamic working directory)
      # .github/terraform/.terraform_workdir.${BRANCH_NAME} íŒŒì¼ì—ì„œ ìž‘ì—… ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ì½ì–´ì™€ì„œ í•´ë‹¹ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
        run: |
          cd "${{ steps.tfworkdir.outputs.workdir }}"
          terraform init

      - name: Terraform Plan
        id: planfile
        run: |
          cd "${{ steps.tfworkdir.outputs.workdir }}"
          export PLAN_FILE=plan_output_$(date +%Y%m%d_%H%M%S)_$(openssl rand -base64 20 | tr -d '=+/' | head -c8).txt
          terraform plan -no-color > $PLAN_FILE
          echo "plan_file=$PLAN_FILE" >> $GITHUB_OUTPUT
        # GITHUB_OUTPUT: step ê°„ì— ê°’ì„ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ìš©ë„
        # ì§ì ‘ íŒŒì¼ë¡œ ê°’ì„ ë„˜ê¸°ëŠ” ë°©ì‹ì´ ì•„ë‹ˆë¼, GitHub Actionsê°€ ë‚´ë¶€ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ìž…ë‹ˆë‹¤.
        # export PLAN_FILE=plan_output_$(date +%Y%m%d_%H%M%S)_$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c8).txt
         

      - name: Commit Plan Output to PR branch
        run: |
          cd "${{ steps.tfworkdir.outputs.workdir }}"
          git add ${{ steps.planfile.outputs.plan_file }}
          git commit -m "chore: add terraform plan output"
          git push origin HEAD:${{ github.head_ref }}

      - name: Comment Plan Summary on PR
        run: |
          echo "### ðŸ“ Terraform Plan Summary" > plan_summary.txt
          echo '```hcl' >> plan_summary.txt
          if grep -E '^(  #|Plan:|  [~+\-])' ${{ steps.planfile.outputs.plan_file }} > plan_grep.txt; then
            cat plan_grep.txt >> plan_summary.txt
          else
            echo "No changes detected." >> plan_summary.txt
          fi
          echo '```' >> plan_summary.txt

          gh auth setup-git
          gh pr comment ${{ github.event.pull_request.number }} --body-file plan_summary.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



#######################################################################################################################




